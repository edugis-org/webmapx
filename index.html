<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebMapX</title>

    <!-- Shoelace themes - both loaded, class on html determines active -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.14.0/cdn/themes/light.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.14.0/cdn/themes/dark.css" />

    <link rel="stylesheet" href="./src/theme/webmapx-style-core.css">

    <link rel="stylesheet" href="./app.css">
    <script type="module" src="./src/app.js"></script>
</head>
<body>
    <div class="table">
        <div>
            <webmapx-map id="map-container" adapter="maplibre" src="config/demo.json">                
                <webmapx-layout>
                    <webmapx-zoom-level slot="top-center"></webmapx-zoom-level>
                    <webmapx-zoom-level slot="top-right"></webmapx-zoom-level>
                    <webmapx-zoom-level slot="middle-right"></webmapx-zoom-level>
                    
                    <!-- Top Left: Toolbar + Panel -->
                    <webmapx-control-group slot="bottom-left" orientation="horizontal" panel-position="before" alignment="start">
                        <webmapx-toolbar id="main-toolbar">
                            <sl-button name="layers" size="medium" circle>
                                <sl-icon name="layers" label="Layers"></sl-icon>
                            </sl-button>
                            <sl-button name="search" size="medium" circle>
                                <sl-icon name="search" label="Search"></sl-icon>
                            </sl-button>
                            <sl-button name="measure" size="medium" circle>
                                <sl-icon name="rulers" label="Measure"></sl-icon>
                            </sl-button>
                            <sl-button name="settings" size="medium" circle>
                                <sl-icon name="gear" label="Settings"></sl-icon>
                            </sl-button>
                            <sl-button name="geolocation" size="medium" circle>
                                <sl-icon name="crosshair" label="Geolocation"></sl-icon>
                            </sl-button>
                        </webmapx-toolbar>

                        <webmapx-tool-panel id="tool-panel" label="Tools">
                            <webmapx-layer-tree id="layer-tool" tool-id="layers"></webmapx-layer-tree>
                            <webmapx-search-tool id="search-tool" tool-id="search"></webmapx-search-tool>
                            <webmapx-measure-tool id="measure-tool" tool-id="measure"></webmapx-measure-tool>
                            <webmapx-settings id="settings-tool" tool-id="settings"></webmapx-settings>
                            <webmapx-geolocation-tool id="geolocation-tool" tool-id="geolocation"></webmapx-geolocation-tool>
                        </webmapx-tool-panel>
                    </webmapx-control-group>
                    <webmapx-scale-control slot="bottom-right" max-width="140"></webmapx-scale-control>

                    <webmapx-coordinates-tool slot="bottom-center"></webmapx-coordinates-tool>
                    <webmapx-inset-map slot="top-left" zoom-offset="-4"></webmapx-inset-map>
                    <webmapx-spinner slot="middle-center"></webmapx-spinner>
                </webmapx-layout>

            </webmapx-map>
        </div>
        
        <!-- External Tools Column -->
        <div>
            <h3>External Tools</h3>
            <p>The tools below are outside the map but linked to it.</p>
            <webmapx-zoom-level map="#map-container"></webmapx-zoom-level>
            <br/>
            <webmapx-inset-map zoom-offset="-5"></webmapx-inset-map>
            <br/>
            <br/>
            <webmapx-tool-template></webmapx-tool-template>
            <webmapx-spinner></webmapx-spinner>
            <br/>
            <div>
                <button id="external-geolocation-button">Use Geolocation</button>
                <div id="external-geolocation-output"></div>
            </div>
        </div>
    </div>

    <script>
        const map = document.getElementById('map-container');
        const externalGeoButton = document.getElementById('external-geolocation-button');
        const externalGeoOutput = document.getElementById('external-geolocation-output');
        const externalToolsHost = externalGeoButton?.closest('div');

        const setExternalGeoLabel = (active) => {
            if (!externalGeoButton) return;
            externalGeoButton.textContent = active ? 'Stop Geolocation' : 'Use Geolocation';
        };

        const updateExternalLabelFromTool = () => {
            const tool = externalToolsHost?.querySelector('webmapx-geolocation-tool');
            setExternalGeoLabel(Boolean(tool?.active));
        };

        map?.addEventListener('webmapx-tool-activated', (e) => {
            if (e.detail?.toolId === 'geolocation') {
                updateExternalLabelFromTool();
            }
        });

        map?.addEventListener('webmapx-tool-deactivated', (e) => {
            if (e.detail?.toolId === 'geolocation') {
                updateExternalLabelFromTool();
            }
        });

        externalGeoButton?.addEventListener('click', () => {
            if (!externalGeoOutput || !externalToolsHost) return;
            let tool = externalToolsHost.querySelector('webmapx-geolocation-tool');
            if (!tool) {
                tool = document.createElement('webmapx-geolocation-tool');
                tool.setAttribute('map', '#map-container');
                tool.setAttribute('render-target', '#external-geolocation-output');
                externalToolsHost.appendChild(tool);
            }
            if (tool.active) {
                tool.deactivate?.();
            } else {
                tool.activate?.();
            }
            updateExternalLabelFromTool();
        });
    </script>

</body>
</html>
